From 598df656702925869cfadb0d41b3edb6ceff401d Mon Sep 17 00:00:00 2001
From: Alec Leamas <leamas.alec@gmail.com>
Date: Wed, 17 Apr 2024 13:59:24 +0200
Subject: [PATCH 2/3] Add missing libs like tinyxml Debian work-around

Since we remove some bundled libs when repacking the sources,
references to these libs causes build problems which must
be patched in the cmake files.

Not acceptable upstream, it's our problem that we remove stuff from
the sources.

Forwarded: not-needed
---
 cmake/SystemLibs.cmake     | 28 ++++++++++++++++++++++++++++
 cmake/in-files/config.h.in |  3 +++
 2 files changed, 31 insertions(+)
 create mode 100644 cmake/SystemLibs.cmake

diff --git a/cmake/SystemLibs.cmake b/cmake/SystemLibs.cmake
new file mode 100644
index 000000000..473722c1b
--- /dev/null
+++ b/cmake/SystemLibs.cmake
@@ -0,0 +1,28 @@
+# Dummy definitions for systems like Debian which removes some bundled libs
+# in the packaging
+
+find_package(TinyXML REQUIRED)
+message(STATUS "Building with system tinyxml")
+add_library(TINYXML INTERFACE)
+target_include_directories(TINYXML INTERFACE ${TINYXML_INCLUDE_DIR})
+target_link_libraries(TINYXML INTERFACE ${TINYXML_LIBRARIES})
+add_library(ocpn::tinyxml ALIAS TINYXML)
+
+message(STATUS "Building with system serial lib")
+add_library(SERIAL_IF INTERFACE)
+find_library(LibSerial cxx-serial REQUIRED)
+find_file(SerialHeader NAME serial.h  REQUIRED)
+target_link_libraries(SERIAL_IF INTERFACE ${LibSerial})
+add_library(ocpn::serial ALIAS SERIAL_IF)
+set(HAVE_SYS_SERIAL_LIB ON CACHE BOOL "")
+
+# The system libserial serial.h lives in /usr/include, not
+# /usr/includ/7serial. Create a link which make the source code using
+# "#include serial/serial.h" work.
+if (NOT EXISTS ${CMAKE_BINARY_DIR}/include)
+  file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/include)
+endif ()
+execute_process(COMMAND ln -s /usr/include ${CMAKE_BINARY_DIR}/include/serial)
+
+find_path(HAVE_STDINT_H NAMES stdint.h)
+find_path(HAVE_SYS_SERIAL_LIB NAMES serial.h)
diff --git a/cmake/in-files/config.h.in b/cmake/in-files/config.h.in
index 47fcdd641..40d0a61ba 100644
--- a/cmake/in-files/config.h.in
+++ b/cmake/in-files/config.h.in
@@ -45,6 +45,9 @@
 #cmakedefine HAVE_SYS_TYPES_H
 #cmakedefine HAVE_SYS_FCNTL_H
 #cmakedefine HAVE_SYS_IOCTL_H
+#cmakedefine HAVE_SYS_SERIAL_LIB
+#cmakedefine HAVE_STDINT_H
+
 
 // The os compatible plugins are are built for
 #define PKG_TARGET "${PKG_TARGET}"
-- 
2.43.0

